<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>INTERPF - Ficha de Ingreso y Seguimiento DBT2</title>
  <link rel="stylesheet" href="style-dbt.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<header class="app-header no-print">
  <h1>INTERPF · Ficha de Ingreso y Seguimiento DBT2 (Dr. Giorgini)</h1>
  <div class="header-actions">
    <button type="button" id="btn-save">Guardar</button>
    <button type="button" id="btn-print">Imprimir / PDF</button>
  </div>
</header>

<main class="container">
  <!-- KPIs / Semáforos -->
  <section id="kpis" class="card no-print">
    <h2>Semáforos clínicos</h2>
    <div class="kpi-grid">
      <div class="kpi"><span>HbA1c</span><strong id="kpi-a1c">—</strong><em id="kpi-a1c-flag" class="flag gray">—</em></div>
      <div class="kpi"><span>LDL (mg/dL)</span><strong id="kpi-ldl">—</strong><em id="kpi-ldl-flag" class="flag gray">—</em></div>
      <div class="kpi"><span>PA (mmHg)</span><strong id="kpi-ta">—</strong><em id="kpi-ta-flag" class="flag gray">—</em></div>
      <div class="kpi"><span>BMI (kg/m²)</span><strong id="kpi-bmi">—</strong><em id="kpi-bmi-flag" class="flag gray">—</em></div>
    </div>
    <p class="muted">Los umbrales son editables en el bloque de configuración del script.</p>
  </section>

  <form id="ficha-ingreso" class="card">
    <h2>A. Datos identificatorios y logísticos</h2>
    <div class="grid2">
      <label>Fecha de inicio<input id="ini" name="ini" type="date" required></label>
      <label>Lugar<input id="lugar" name="lugar" type="text" value="Hospital Alemán" required></label>

      <label>Nombre y Apellido<input id="nombre" name="nombre" type="text" required></label>
      <label>Documento de identidad<input id="dni" name="dni" type="text" required></label>

      <label>Fecha de nacimiento<input id="fnac" name="fnac" type="date"></label>
      <label>Edad (auto)<input id="edad-auto" type="text" placeholder="Automático" readonly></label>

      <label>Sexo
        <select id="sexo" name="sexo">
          <option value=""></option><option>Femenino</option><option>Masculino</option><option>Otro</option>
        </select>
      </label>
      <label>Médico tratante<input id="med-trat" name="med-trat" type="text" value="Dr. Julio Giorgini"></label>
    </div>

    <div class="grid3">
      <label>Dirección / Ciudad<input id="direccion" name="direccion" type="text"></label>
      <label>Teléfono<input id="tel" name="tel" type="tel"></label>
      <label>Mail<input id="mail" name="mail" type="email"></label>
    </div>

    <hr>
    <h2>B. Antecedentes y factores de riesgo modificables</h2>
    <div class="grid3">
      <label>Años de Dx DBT<input id="anios-dbt" name="anios-dbt" type="number" min="0" step="1"></label>
      <label>Tipo de diabetes
        <select id="tipo-dbt" name="tipo-dbt">
          <option>Tipo 2</option>
          <option>Tipo 2 insulino-requiriente</option>
          <option>Tipo 1</option>
        </select>
      </label>
      <label>Antecedentes CV<input id="ant-cv" name="ant-cv" type="text" placeholder="IAM, ACV, IC, etc."></label>
      <label>VIH
        <select id="vih" name="vih"><option>No</option><option>Sí</option></select>
      </label>
    </div>

    <h3>Parámetros antropométricos</h3>
    <div class="grid4">
      <label>Altura (m)<input id="altura" name="altura" type="number" step="0.01"></label>
      <label>Peso (kg)<input id="peso" name="peso" type="number" step="0.1"></label>
      <label>BMI (auto)
        <div class="inline">
          <input id="bmi" type="text" readonly>
          <a class="link" href="https://www.mdcalc.com/calc/29/body-mass-index-bmi-body-surface-area-bsa" target="_blank">MDCalc</a>
        </div>
      </label>
      <label>Perím. cintura (cm)<input id="cintura" name="cintura" type="number" step="0.1"></label>
      <label>Rel. cintura/altura (auto)<input id="rel-ca" type="text" readonly></label>
    </div>

    <h3 class="title-right">
      Riesgo SAOS (STOP-BANG)
      <a class="title-link" target="_blank" href="https://www.mdcalc.com/calc/3992/stop-bang-score-obstructive-sleep-apnea">Calculadora</a>
    </h3>
    <div class="grid3">
      <label>Puntaje STOP-BANG<input id="stopbang" name="stopbang" type="text" placeholder="0–8"></label>
    </div>

    <h3 class="title-right">
      Cribado de Depresión (PHQ-2)
      <a class="title-link" target="_blank" href="https://aidsetc.org/sites/default/files/resources_files/PHQ-2_Spanish.pdf">Referencia</a>
    </h3>
    <div class="grid3">
      <label>Puntaje PHQ-2<input id="phq2" name="phq2" type="text" placeholder="0–6"></label>
    </div>

    <h3>Estilo de vida</h3>
    <div class="grid3">
      <label>Tabaquismo
        <select id="tabaco" name="tabaco"><option>Actual</option><option>Ex-fumador</option><option>Nunca</option></select>
      </label>
      <label>Alcohol
        <select id="alcohol" name="alcohol"><option>Abstinente</option><option>Social</option><option>Riesgo</option></select>
      </label>
      <label class="chk"><input id="fv" name="fv" type="checkbox"> Dieta: frutas y verduras diarias</label>
      <label class="chk"><input id="azucares" name="azucares" type="checkbox"> Dieta: azúcares diarios</label>
      <label class="chk"><input id="carb" name="carb" type="checkbox"> Conteo de carbohidratos correcto</label>
      <label class="chk"><input id="aerobico" name="aerobico" type="checkbox"> Ejercicio aeróbico ≥150 min/sem</label>
    </div>

    <div class="grid3">
      <label>Antecedentes quirúrgicos<textarea id="qx" name="qx" rows="1"></textarea></label>
      <label>Internaciones (causas)<textarea id="intern" name="intern" rows="1"></textarea></label>
      <label>Patología respiratoria<textarea id="resp" name="resp" rows="1"></textarea></label>
    </div>

    <hr>
    <h2>D. Tratamiento actual (lista detallada)</h2>
    <p class="muted">Marque las drogas que usa el paciente y complete dosis y frecuencia.</p>

    <!-- === LISTA DE DROGAS (tu listado) === -->
    <div class="medication-list-vertical">
      <h3>1. Hipoglucemiantes Orales</h3>
      <div class="med-item"><input type="checkbox" id="metf"><label for="metf">Metformina (Biguanida)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="glib"><label for="glib">Glibenclamida (SU)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="piog"><label for="piog">Pioglitazona (TZD)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>

      <h3>2. Incretinas y DPP-4</h3>
      <div class="med-item"><input type="checkbox" id="sita"><label for="sita">Sitagliptina / Linagliptina (iDPP4)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>

      <h3>3. Inhibidores SGLT2</h3>
      <div class="med-item"><input type="checkbox" id="empa"><label for="empa">Empagliflozina</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="dapa"><label for="dapa">Dapagliflozina</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>

      <h3>4. Agonistas GLP-1</h3>
      <div class="med-item"><input type="checkbox" id="sema"><label for="sema">Semaglutida (Subcutánea/Oral)</label><input type="text" placeholder="Dosis" class="input-dosis"><input type="number" placeholder="Frecuencia" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="lira"><label for="lira">Liraglutida</label><input type="text" placeholder="Dosis" class="input-dosis"><input type="number" placeholder="Frecuencia" class="input-frec"></div>

      <h3>5. Insulinas y Análogos</h3>
      <div class="med-item"><input type="checkbox" id="glarg"><label for="glarg">Glargina (Basal)</label><input type="text" placeholder="Dosis (UI)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="deg"><label for="deg">Degludec (Basal)</label><input type="text" placeholder="Dosis (UI)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="lispro"><label for="lispro">Lispro / Aspártica (Rápida)</label><input type="text" placeholder="Dosis (UI)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>

      <h3>6. IECA y ARA II (Antihipertensivos)</h3>
      <div class="med-item"><input type="checkbox" id="enal"><label for="enal">Enalapril (IECA)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="ramip"><label for="ramip">Ramipril (IECA)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="losar"><label for="losar">Losartán (ARA II)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="valsar"><label for="valsar">Valsartán (ARA II)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>

      <h3>7. Betabloqueantes y BCC</h3>
      <div class="med-item"><input type="checkbox" id="carve"><label for="carve">Carvedilol (BetaB)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="bisop"><label for="bisop">Bisoprolol (BetaB)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="amlod"><label for="amlod">Amlodipina (BCC)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>

      <h3>8. ARM y Diuréticos</h3>
      <div class="med-item"><input type="checkbox" id="espiro"><label for="espiro">Espironolactona (ARM)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="eple"><label for="eple">Eplerenona (ARM)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="fineren"><label for="fineren">Finerenona (ARM)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="fur"><label for="fur">Furosemida (Diurético)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>

      <h3>9. Dislipidemia</h3>
      <div class="med-item"><input type="checkbox" id="atorva"><label for="atorva">Atorvastatina</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="rosuva"><label for="rosuva">Rosuvastatina</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="eze"><label for="eze">Ezetimibe</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="ipe"><label for="ipe">Icosapento de Etilo (IPE)</label><input type="text" placeholder="Dosis (g)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>

      <h3>10. Antitrombóticos</h3>
      <div class="med-item"><input type="checkbox" id="aas"><label for="aas">Aspirina (AAS)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="clopi"><label for="clopi">Clopidogrel</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="riva"><label for="riva">Rivaroxabán (DOAC)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="api"><label for="api">Apixabán (DOAC)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="warfa"><label for="warfa">Warfarina / Acenocumarol (AVK)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>

      <h3>11. Comorbilidades</h3>
      <div class="med-item"><input type="checkbox" id="amio"><label for="amio">Amiodarona (Antiarritmico)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="levo"><label for="levo">Levotiroxina (Tiroides)</label><input type="text" placeholder="Dosis (mcg)" class="input-dosis"><input type="number" placeholder="Veces/día" value="1" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="sertr"><label for="sertr">Sertralina / Escitalopram (Psiquiátrica)</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="omep"><label for="omep">Omeprazol / IBP</label><input type="text" placeholder="Dosis (mg)" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
      <div class="med-item"><input type="checkbox" id="otro"><label for="otro">Otra medicación (especifique):</label><input type="text" placeholder="Nombre/Dosis" class="input-dosis"><input type="number" placeholder="Veces/día" class="input-frec"></div>
    </div>
    <!-- === FIN LISTA DE DROGAS === -->

    <hr>
    <h2>E. Examen físico y laboratorio</h2>
    <div class="grid3">
      <label>FC (lpm)<input id="fc" name="fc" type="number" min="0"></label>
      <label>TA (mmHg: 120/70)<input id="ta" name="ta" type="text" placeholder="Ej.: 130/80"></label>
    </div>

    <h3>Laboratorio</h3>
    <div class="grid3">
      <label>HbA1c %<input id="a1c" name="a1c" type="number" step="0.1"></label>
      <label>LDL mg/dL<input id="ldl" name="ldl" type="number" step="1"></label>
      <label>Glucemia mg/dL<input id="gluc" name="gluc" type="number" step="1"></label>
      <label>Urea<input id="urea" name="urea" type="text"></label>
      <label>Creatinina<input id="creat" name="creat" type="text"></label>
      <label>TSH<input id="tsh" name="tsh" type="text"></label>
      <label>PCR<input id="pcr" name="pcr" type="text"></label>
      <label>Ferritina<input id="ferritina" name="ferritina" type="text"></label>
      <label>Vitamina D<input id="vitd" name="vitd" type="text"></label>
    </div>

    <hr>
    <h2>F. Plan de seguimiento</h2>
    <div class="grid3">
      <label>Tipo de control
        <select id="tipo-ctrl" name="tipo-ctrl"><option>Presencial</option><option>Virtual (Zoom/Video)</option><option>Mail</option></select>
      </label>
      <label>Fecha de control (alarma)<input id="prox" name="prox" type="date" required></label>
      <label>Estado<input id="estado" type="text" readonly></label>
    </div>

    <label>Indicaciones (INTERPAC)<textarea id="indic" name="indic" rows="3" placeholder="Estas indicaciones se verán en la plataforma del paciente."></textarea></label>
    <label>Objetivos para el próximo control<textarea id="objet" name="objet" rows="2" placeholder="Ej.: HbA1c < 7.0, bajar 1 kg…"></textarea></label>

    <div class="actions">
      <button type="submit" class="primary">Guardar ficha</button>
      <button type="button" id="btn-mail">Enviar mail al paciente</button>
      <button type="button" id="btn-clear">Limpiar</button>
    </div>
  </form>
</main>

<footer class="print-footer only-print">
  <p>INTERPF – Seguimiento DBT2 · Dr. Julio C. Giorgini</p>
</footer>

<script>
/* ===== CONFIG: UMBRALES y ENDPOINTS opcionales ===== */
const UMBRALES = { a1c_max: 7.0, ldl_max: 70, tas_max: 130, tad_max: 80, bmi_min: 18.5, bmi_max: 25 };
const PATIENT_SYNC_URL = "";   // ← si tienes backend para sincronizar la app del paciente (POST JSON)
const MAIL_WEBHOOK_URL = "";   // ← si tienes webhook para enviar el mail desde servidor (POST JSON)
/* =================================================== */

const $ = (id) => document.getElementById(id);
const form = $('ficha-ingreso');

/* Edad */
$('fnac').addEventListener('change', ()=> {
  const v = $('fnac').value;
  if (!v) return $('edad-auto').value = '';
  const d = new Date(v), t = new Date();
  let edad = t.getFullYear() - d.getFullYear();
  const m = t.getMonth() - d.getMonth();
  if (m < 0 || (m === 0 && t.getDate() < d.getDate())) edad--;
  $('edad-auto').value = isFinite(edad) ? edad : '';
});

/* BMI / Relación cintura-altura */
['altura','peso','cintura'].forEach(id => $(id).addEventListener('input', calcBody));
function calcBody(){
  const h = parseFloat($('altura').value || '0');
  const w = parseFloat($('peso').value || '0');
  const c = parseFloat($('cintura').value || '0');
  const bmi = (h>0 && w>0) ? (w/(h*h)) : NaN;
  $('bmi').value = isNaN(bmi) ? '' : (Math.round(bmi*10)/10);
  $('rel-ca').value = (h>0 && c>0) ? (Math.round((c/(h*100))*10)/10) : '';
  updateKPI();
}

/* KPI / Estado */
$('ta').addEventListener('input', updateKPI);
['a1c','ldl','prox','tipo-ctrl','indic','objet'].forEach(id => $(id).addEventListener('input', updateKPI));
function updateKPI(){
  const a1c = parseFloat($('a1c').value);
  const ldl = parseFloat($('ldl').value);
  const bmi = parseFloat($('bmi').value);
  const ta = $('ta').value.trim();
  $('kpi-a1c').textContent = isNaN(a1c)?'—':a1c.toFixed(1);
  $('kpi-ldl').textContent = isNaN(ldl)?'—':ldl.toFixed(0);
  $('kpi-bmi').textContent = isNaN(bmi)?'—':bmi.toFixed(1);
  $('kpi-ta').textContent = ta || '—';

  flag('kpi-a1c-flag', !isNaN(a1c) && a1c <= UMBRALES.a1c_max);
  flag('kpi-ldl-flag', !isNaN(ldl) && ldl <= UMBRALES.ldl_max);

  let okPA = false;
  if (ta && ta.includes('/')){
    const [tas,tad] = ta.split('/').map(x=>parseInt(x,10));
    okPA = Number.isFinite(tas) && Number.isFinite(tad) && tas < UMBRALES.tas_max && tad < UMBRALES.tad_max;
  }
  flag('kpi-ta-flag', okPA);

  const okBMI = Number.isFinite(bmi) && bmi >= UMBRALES.bmi_min && bmi <= UMBRALES.bmi_max;
  flag('kpi-bmi-flag', okBMI);

  // Estado
  const prox = $('prox').value;
  if (prox){
    const d = Math.ceil((new Date(prox) - new Date())/(1000*60*60*24));
    $('estado').value = isFinite(d) ? (d >= 0 ? 'al día' : 'atrasado') : 'sin fecha';
  } else {
    $('estado').value = 'sin fecha';
  }
}
function flag(id, ok){
  const el = $(id);
  if (ok==null){ el.textContent='—'; el.className='flag gray'; return; }
  el.textContent = ok ? 'OK' : 'Revisar';
  el.className = 'flag ' + (ok ? 'green' : 'red');
}

/* Guardar e imprimir */
$('btn-print').addEventListener('click', ()=> window.print());
$('btn-save').addEventListener('click', saveDraft);

/* Autosave */
const STORAGE_KEY = 'INTERPF_DBT2_FICHA';
restoreDraft();
form.addEventListener('input', debounce(saveDraft, 400));
function saveDraft(e){
  const data = getPayload();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  if (e?.type==='click') alert('Borrador guardado en este equipo.');
}
function restoreDraft(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  const data = JSON.parse(raw);
  for (const [k,v] of Object.entries(data)){
    const el = document.querySelector(`[name="${k}"]`) || $(k);
    if (!el) continue;
    if (el.type==='checkbox') el.checked = v === 'on' || v === true;
    else el.value = v;
  }
  calcBody(); updateKPI();
}

/* Envío / sincronización */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  updateKPI();
  await syncPatientApp();  // actualiza app del paciente (si hay endpoint)
  alert('Ficha guardada. (Sincronización realizada si fue configurada).');
});

/* Botón: Enviar mail al paciente */
$('btn-mail').addEventListener('click', async ()=>{
  const data = getPayload();
  // 1) Mailto local (abre el cliente del usuario)
  const to = data.mail || "";
  const subject = encodeURIComponent(`Seguimiento y próximo control – ${data.nombre || ''}`);
  const body = encodeURIComponent(
`Hola ${data.nombre || ''},

Tipo de control: ${data['tipo-ctrl'] || '-'}
Fecha del próximo control: ${data.prox || '-'}
Indicaciones:
${data.indic || '-'}

Objetivos:
${data.objet || '-'}

Saludos,
${data['med-trat'] || 'Su equipo médico'}`);

  window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;

  // 2) (Opcional) Envío por webhook si fue configurado
  if (MAIL_WEBHOOK_URL){
    try{
      await fetch(MAIL_WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,body})});
    }catch(e){ console.warn('MAIL_WEBHOOK falló:', e); }
  }
});

/* Sincronizar app del paciente (fecha, tipo, indicaciones, objetivos) */
async function syncPatientApp(){
  if (!PATIENT_SYNC_URL) return;
  const subset = {
    nombre: $('nombre').value,
    prox: $('prox').value,
    tipo_ctrl: $('tipo-ctrl').value,
    indicaciones: $('indic').value,
    objetivos: $('objet').value,
    dni: $('dni').value,
    mail: $('mail').value
  };
  try{
    await fetch(PATIENT_SYNC_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(subset)});
  }catch(e){ console.warn('PATIENT_SYNC_URL falló:', e); }
}

/* Utilidades */
function getPayload(){
  const data = Object.fromEntries(new FormData(form).entries());
  data.bmi = $('bmi').value;
  data.rel_ca = $('rel-ca').value;
  data.edad = $('edad-auto').value;
  return data;
}
function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), ms); }; }

/* Inicial */
calcBody(); updateKPI();
</script>
</body>
</html>
