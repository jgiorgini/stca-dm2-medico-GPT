<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>INTERPAC Â· Plan de Diabetes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7fafc; --panel:#ffffff; --line:#d8e2ee;
      --text:#0f172a; --muted:#475569;
      --accent:#0b72ff; --accent-strong:#0753bf;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    }
    @font-face{
      font-family:"Century Gothic";
      src: local("Century Gothic"), local("CenturyGothic");
      font-display:swap;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Century Gothic","AppleGothic","URW Gothic L","Avant Garde",Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      line-height:1.55;
    }
    .container{max-width:860px;margin:20px auto;padding:0 16px}
    header{
      display:flex;flex-direction:column;gap:6px;margin-bottom:14px;padding:14px 0;
    }
    header h1{margin:0;font-size:22px;color:var(--accent-strong)}
    header p{margin:0;color:var(--muted)}
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:16px;
      padding:16px; margin:14px 0; box-shadow:0 10px 18px rgba(0,0,0,.06);
    }
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    .big-text{font-size:15px;margin:6px 0}
    .big-date{font-size:16px;margin:4px 0 0}
    .content-box{display:flex;flex-direction:column;gap:8px}
    .content-box p{margin:0}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:#f0f5ff;color:#0b3d91;font-weight:700;font-size:13px;
    }
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button,a.button{
      appearance:none;border:1px solid var(--line);background:#eef4ff;
      color:#0b3d91;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;text-decoration:none;
    }
    button.primary,a.button.primary{background:var(--accent);color:#fff;border-color:transparent}
    .muted{color:var(--muted);font-size:13px}
    .foot{margin:10px 2px;color:var(--muted);font-size:12px}
    @media (max-width:520px){
      header h1{font-size:20px}
      .pill{width:100%;justify-content:center}
      .actions{flex-direction:column}
      button,a.button{width:100%}
      <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b72ff">
<link rel="icon" href="icons/icon-192.png">
<!-- Opcional iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="INTERPAC">
<link rel="apple-touch-icon" href="icons/icon-192.png">
    }
  </style>
</head>
<body>
  <main class="container" id="app">
    <header>
      <h1 id="title">Bienvenido/a</h1>
      <p>Su Plataforma de Seguimiento de Diabetes</p>
    </header>

    <section class="card">
      <h2>PrÃ³ximo contacto pautado</h2>
      <div class="row">
        <span class="pill" id="mode-pill">Modo: â€”</span>
        <span class="pill" id="date-pill">Fecha: â€”</span>
      </div>
      <p class="big-text" id="mode-text">Debe â€”</p>
      <p class="big-date" id="date-text">Fecha lÃ­mite: <strong>â€”</strong></p>
      <p class="muted">Por favor, comunÃ­quese en o antes de esta fecha para mantener su seguimiento activo.</p>
      <div class="actions">
        <button class="primary" id="btn-ics">Agregar recordatorio (calendario)</button>
        <button id="btn-done">Ya me comuniquÃ©</button>
      </div>
    </section>

    <section class="card">
      <h2>âœ… Indicaciones actuales</h2>
      <div id="indicaciones" class="content-box">
        <p>â€”</p>
      </div>
    </section>

    <section class="card">
      <h2>ðŸŽ¯ Objetivos de salud</h2>
      <div id="objetivos" class="content-box">
        <p>â€”</p>
      </div>
    </section>

    <section class="card">
      <h2>Contacto del equipo</h2>
      <p id="doctor">MÃ©dico tratante: â€”</p>
      <p id="email">Email para controles: â€”</p>
      <p id="phone">TelÃ©fono: â€”</p>
      <div class="actions">
        <a id="btn-mailto" class="button primary" href="#" target="_blank" rel="noopener">Enviar correo ahora</a>
        <button id="btn-copy-mail">Copiar email</button>
      </div>
    </section>

    <p class="foot">INTERPAC â€“ versiÃ³n paciente (modo claro). Si tiene dudas, comunÃ­quese con su equipo tratante.</p>
  </main>

  <script>
    // ========= UTIL: lectura de parÃ¡metros de URL =========
    function getParams(){
      const u = new URL(window.location.href);
      const g = (k) => u.searchParams.get(k) || "";
      // Permitir listas separadas por salto de lÃ­nea o %0A
      const toLines = (s) => !s ? [] : s.split(/\r?\n/).filter(Boolean);
      return {
        name:  g("name"),
        mode:  g("mode"),
        date:  g("date"),           // ISO (YYYY-MM-DD) recomendado
        indic: toLines(g("indic")),
        goals: toLines(g("goals")),
        doctor:g("doctor"),
        email: g("email"),
        phone: g("phone")
      };
    }

    // ========= RENDER =========
    function render(data){
      // TÃ­tulo
      document.getElementById("title").textContent = `Bienvenido/a ${data.name || ""}`.trim() || "Bienvenido/a";

      // PrÃ³ximo contacto
      const mode = data.mode || "â€”";
      const dateISO = data.date || "";
      const fechaFmt = dateISO ? new Date(dateISO + "T00:00:00").toLocaleDateString() : "â€”";

      document.getElementById("mode-pill").textContent = `Modo: ${mode}`;
      document.getElementById("date-pill").textContent = `Fecha: ${fechaFmt}`;
      document.getElementById("mode-text").textContent = `Debe ${mode}`;
      document.getElementById("date-text").innerHTML = `Fecha lÃ­mite: <strong>${fechaFmt}</strong>`;

      // Indicaciones
      const indBox = document.getElementById("indicaciones");
      indBox.innerHTML = "";
      if (data.indic && data.indic.length){
        data.indic.forEach(t => {
          const p = document.createElement("p");
          p.textContent = "â€” " + t;
          indBox.appendChild(p);
        });
      } else { indBox.innerHTML = "<p>â€”</p>"; }

      // Objetivos
      const objBox = document.getElementById("objetivos");
      objBox.innerHTML = "";
      if (data.goals && data.goals.length){
        data.goals.forEach(t => {
          const p = document.createElement("p");
          p.textContent = "â€” " + t;
          objBox.appendChild(p);
        });
      } else { objBox.innerHTML = "<p>â€”</p>"; }

      // Contacto
      document.getElementById("doctor").textContent = `MÃ©dico tratante: ${data.doctor || "â€”"}`;
      document.getElementById("email").innerHTML = `Email para controles: ${
        data.email ? '<a href="mailto:'+data.email+'">'+data.email+'</a>' : "â€”"
      }`;
      document.getElementById("phone").textContent = `TelÃ©fono: ${data.phone || "â€”"}`;

      // BotÃ³n mail directo
      const subject = encodeURIComponent(`EnvÃ­o de controles â€“ ${data.name || ""}`);
      const body = encodeURIComponent(
        `Hola ${data.doctor || "equipo"},\n\nAdjunto controles solicitados.\n\nSaludos,\n${data.name || ""}`
      );
      document.getElementById("btn-mailto").href = data.email ? `mailto:${data.email}?subject=${subject}&body=${body}` : "#";

      // BotÃ³n ICS (evento calendario)
      const icsBtn = document.getElementById("btn-ics");
      icsBtn.onclick = () => downloadICS(data);

      // BotÃ³n "Ya me comuniquÃ©"
      document.getElementById("btn-done").onclick = () => {
        localStorage.setItem("INTERPAC_DONE", new Date().toISOString());
        alert("Â¡Gracias! Marcado como realizado.");
      };

      // Copiar email
      document.getElementById("btn-copy-mail").onclick = async () => {
        if (!data.email) return alert("No hay email de destino.");
        try{ await navigator.clipboard.writeText(data.email); alert("Email copiado."); }
        catch{ alert("No se pudo copiar el email."); }
      };
    }

    // ========= ICS generator =========
    function downloadICS(data){
      if (!data.date){ alert("No hay fecha cargada."); return; }
      const dt = new Date(data.date + "T09:00:00"); // 9am local
      const dtEnd = new Date(dt.getTime() + 30*60000);
      const pad = (n)=> String(n).padStart(2,"0");
      const toUTC = (d)=> (
        d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate()) + "T" +
        pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + "00Z"
      );
      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//INTERPAC//DBT2//ES
BEGIN:VEVENT
UID:${Date.now()}@interpac
DTSTAMP:${toUTC(new Date())}
DTSTART:${toUTC(dt)}
DTEND:${toUTC(dtEnd)}
SUMMARY:${(data.mode||"Contacto")} con el equipo
DESCRIPTION:Indicaciones:\\n${(data.indic||[]).join(" | ")}\\nObjetivos:\\n${(data.goals||[]).join(" | ")}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics],{type:"text/calendar"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "interpac-recordatorio.ics";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ========= Ingesta de datos: URL params, window.INTERPAC_DATA, postMessage =========
    function fromEmbedded(){
      // 1) URL params
      const params = getParams();

      // 2) window.INTERPAC_DATA (si existe)
      const embedded = (typeof window.INTERPAC_DATA === "object") ? window.INTERPAC_DATA : null;

      // 3) merge preferente: embedded > params
      const data = Object.assign({
        name:"", mode:"", date:"", indic:[], goals:[],
        doctor:"", email:"", phone:""
      }, params, embedded);

      render(data);

      // 4) postMessage (si se usa en iframe)
      window.addEventListener("message", (ev)=>{
        if (!ev?.data || ev.data.type!=="INTERPAC_UPDATE") return;
        const payload = ev.data.payload || {};
        render(Object.assign({}, data, payload));
      });
    }

    fromEmbedded();
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
    <button id="btn-install" style="display:none">Instalar app</button>
<script type="module">
  import { installApp } from './interpac.js';
  document.getElementById('btn-install').addEventListener('click', installApp);
  </script>
</body>
</html>


